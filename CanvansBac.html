<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡å›¾ç‰‡ç”»å¸ƒç¼–è¾‘å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            overflow: hidden;
        }
        
        .canvas-container {
            background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #e5e7eb 75%), 
                              linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #fff;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* é€‰ä¸­å›¾ç‰‡çš„æ ·å¼ */
        .img-item.active {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen text-gray-800">

    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="w-full md:w-96 bg-white shadow-xl z-10 flex flex-col h-auto md:h-full overflow-hidden border-r border-gray-200">
        
        <!-- é¡¶éƒ¨æ ‡é¢˜ä¸ä¸Šä¼  -->
        <div class="p-5 border-b border-gray-100 flex-none bg-white z-20">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                æ‰¹é‡ç”»å¸ƒç¼–è¾‘å™¨
            </h1>
            
            <div class="relative border-2 border-dashed border-blue-200 bg-blue-50 rounded-lg p-3 hover:bg-blue-100 transition text-center cursor-pointer group" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" multiple class="hidden" onchange="handleImageUpload(event)">
                <div class="text-blue-600 font-medium text-sm flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    ç‚¹å‡»æ·»åŠ å›¾ç‰‡ (æ”¯æŒå¤šé€‰)
                </div>
            </div>
        </div>

        <!-- ä¸­é—´æ»šåŠ¨åŒºåŸŸï¼šå›¾ç‰‡åˆ—è¡¨ + è®¾ç½® -->
        <div class="flex-1 overflow-y-auto no-scrollbar p-5 space-y-6">
            
            <!-- å›¾ç‰‡åˆ—è¡¨ -->
            <div id="imageListContainer" class="space-y-2 hidden">
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">å›¾ç‰‡åˆ—è¡¨ (<span id="imgCount">0</span>)</label>
                    <button onclick="clearAllImages()" class="text-xs text-red-500 hover:text-red-700">æ¸…ç©º</button>
                </div>
                <div id="imgList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-100 rounded-md p-1 bg-gray-50">
                    <!-- JS ç”Ÿæˆåˆ—è¡¨é¡¹ -->
                </div>
            </div>

            <!-- åˆ†è¾¨ç‡è®¾ç½® -->
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">ç”»å¸ƒåˆ†è¾¨ç‡ (å…¨å±€)</label>
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <span class="absolute left-2 top-2 text-xs text-gray-400">W</span>
                        <input type="number" id="canvasWidth" value="1080" class="w-full pl-6 pr-2 py-1.5 text-sm border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none" oninput="updateCanvasSize()">
                    </div>
                    <div class="relative">
                        <span class="absolute left-2 top-2 text-xs text-gray-400">H</span>
                        <input type="number" id="canvasHeight" value="1080" class="w-full pl-6 pr-2 py-1.5 text-sm border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none" oninput="updateCanvasSize()">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="setResolution(1080, 1080)" class="flex-1 text-xs bg-gray-100 py-1.5 rounded hover:bg-gray-200 text-gray-600">1:1</button>
                    <button onclick="setResolution(1920, 1080)" class="flex-1 text-xs bg-gray-100 py-1.5 rounded hover:bg-gray-200 text-gray-600">16:9</button>
                    <button onclick="setResolution(1080, 1920)" class="flex-1 text-xs bg-gray-100 py-1.5 rounded hover:bg-gray-200 text-gray-600">9:16</button>
                </div>
            </div>

            <!-- èƒŒæ™¯é¢œè‰² -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">èƒŒæ™¯é¢œè‰² (å…¨å±€)</label>
                <div class="flex items-center gap-3 bg-white p-2 rounded border border-gray-200">
                    <input type="color" id="bgColor" value="#ffffff" class="h-6 w-8 p-0 border-0 rounded cursor-pointer" oninput="draw()">
                    <span class="text-xs text-gray-500">ç‚¹å‡»è‰²å—ä¿®æ”¹</span>
                </div>
            </div>

            <!-- å½“å‰å›¾ç‰‡è°ƒæ•´ -->
            <div class="space-y-3 pt-2 border-t border-gray-100">
                <div class="flex justify-between items-center">
                    <label class="block text-sm font-medium text-gray-700">å½“å‰å›¾ç‰‡è°ƒæ•´</label>
                    <button onclick="resetCurrentImage()" class="text-xs text-blue-600 hover:text-blue-800">é‡ç½®ä¸º100%</button>
                </div>
                
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-xs text-gray-500">ç¼©æ”¾</span>
                        <span id="scaleValue" class="text-xs text-gray-500">100%</span>
                    </div>
                    <input type="range" id="scaleSlider" min="0.1" max="5" step="0.01" value="1" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateScaleFromSlider(this.value)">
                </div>

                <!-- æ‰¹é‡åº”ç”¨æŒ‰é’® -->
                <button onclick="applyLayoutToAll()" class="w-full text-xs bg-indigo-50 text-indigo-700 py-2 rounded hover:bg-indigo-100 border border-indigo-200 transition">
                    âš¡ å°†å½“å‰ä½ç½®ä¸ç¼©æ”¾åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡
                </button>
                <p class="text-[10px] text-gray-400">
                    * ä»…å½“æ‰€æœ‰å›¾ç‰‡å°ºå¯¸ç›¸åŒæ—¶å»ºè®®ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œå¦åˆ™è¯·å•ç‹¬è°ƒæ•´ã€‚
                </p>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼å‡ºåŒºåŸŸ -->
        <div class="p-5 border-t border-gray-200 bg-gray-50 space-y-3">
            <button onclick="downloadCurrent()" class="w-full bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                ä»…å¯¼å‡ºå½“å‰
            </button>
            <button id="btnZip" onclick="downloadAllZip()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow-lg flex items-center justify-center gap-2 transition transform active:scale-95 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                æ‰“åŒ…å¯¼å‡ºæ‰€æœ‰ (ZIP)
            </button>
        </div>
    </div>

    <!-- å³ä¾§ç”»å¸ƒé¢„è§ˆåŒºåŸŸ -->
    <div class="flex-1 bg-gray-200 relative overflow-hidden flex items-center justify-center canvas-container p-4" id="canvasWrapper">
        <canvas id="mainCanvas" class="shadow-2xl cursor-move"></canvas>
        
        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div id="emptyState" class="absolute pointer-events-none text-center p-8">
            <div class="bg-white/80 backdrop-blur rounded-xl p-6 shadow-sm border border-gray-200">
                <p class="text-gray-500 font-medium">ğŸ‘ˆ è¯·åœ¨å·¦ä¾§æ·»åŠ å›¾ç‰‡å¼€å§‹</p>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <p class="text-gray-800 font-medium" id="loadingText">å¤„ç†ä¸­...</p>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');
        
        // çŠ¶æ€ç®¡ç†
        // images ç»“æ„:Array<{ id, file, imgObj, x, y, scale, name, loaded }>
        let images = [];
        let activeIndex = -1;
        let isDragging = false;
        let startX, startY;

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            updateCanvasSize();
            draw();
            setupEvents();
            updateUI();
        };

        // --- 1. å›¾ç‰‡ç®¡ç†é€»è¾‘ ---

        async function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            showLoading(true, 'æ­£åœ¨åŠ è½½å›¾ç‰‡...');

            // ä½¿ç”¨ Promise.all ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼Œä»¥ä¾¿è·å–åˆå§‹å°ºå¯¸
            const loadPromises = files.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = () => {
                            resolve({
                                id: Date.now() + Math.random(),
                                file: file,
                                imgObj: img,
                                name: file.name,
                                x: 0,
                                y: 0,
                                scale: 1,
                                loaded: true
                            });
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });

            const newImages = await Promise.all(loadPromises);
            
            // å¯¹æ¯å¼ æ–°å›¾ç‰‡è¿›è¡Œåˆå§‹å¸ƒå±€è®¡ç®— (é»˜è®¤ 100%)
            newImages.forEach(imgData => {
                const layout = calculateDefaultLayout(imgData.imgObj);
                imgData.x = layout.x;
                imgData.y = layout.y;
                imgData.scale = layout.scale;
            });

            // æ·»åŠ åˆ°ä¸»æ•°ç»„
            images = [...images, ...newImages];
            
            // å¦‚æœä¹‹å‰æ²¡æœ‰é€‰ä¸­å›¾ç‰‡ï¼Œé€‰ä¸­ç¬¬ä¸€å¼ æ–°å›¾ç‰‡
            if (activeIndex === -1 && images.length > 0) {
                activeIndex = 0;
            }

            // æ¸…é™¤ input ä»¥ä¾¿æ”¯æŒé‡å¤ä¸Šä¼ ç›¸åŒæ–‡ä»¶
            document.getElementById('fileInput').value = '';

            updateImageList();
            draw();
            showLoading(false);
        }

        // è®¡ç®—å›¾ç‰‡åœ¨ç”»å¸ƒä¸­çš„é»˜è®¤å¸ƒå±€ï¼ˆ100% å±…ä¸­ï¼‰
        function calculateDefaultLayout(imgObj) {
            const canvasW = canvas.width;
            const canvasH = canvas.height;
            const imgW = imgObj.width;
            const imgH = imgObj.height;

            // é»˜è®¤ 100%
            const scale = 1;

            const x = (canvasW - imgW * scale) / 2;
            const y = (canvasH - imgH * scale) / 2;

            return { x, y, scale };
        }

        function setActiveImage(index) {
            activeIndex = index;
            updateImageList();
            // åŒæ­¥æ»‘å—
            if (images[index]) {
                document.getElementById('scaleSlider').value = images[index].scale;
                document.getElementById('scaleValue').innerText = Math.round(images[index].scale * 100) + '%';
            }
            draw();
        }

        function removeImage(e, index) {
            e.stopPropagation(); // é˜²æ­¢è§¦å‘ setActiveImage
            images.splice(index, 1);
            
            if (images.length === 0) {
                activeIndex = -1;
            } else if (activeIndex >= images.length) {
                activeIndex = images.length - 1;
            } else if (activeIndex === index) {
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ï¼Œä¿æŒ activeIndex æˆ–è€…å‡ 1ï¼ˆå¦‚æœå®ƒæ˜¯æœ€åä¸€ä¸ªï¼‰
                activeIndex = Math.max(0, activeIndex - 1);
            }
            // å¦‚æœ activeIndex åœ¨åˆ é™¤é¡¹ä¹‹åï¼Œå®ƒéœ€è¦å‡ 1
            else if (activeIndex > index) {
                activeIndex--;
            }

            updateImageList();
            draw();
        }

        function clearAllImages() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ')) {
                images = [];
                activeIndex = -1;
                updateImageList();
                draw();
            }
        }

        // --- 2. æ‰¹é‡ä¸ç¼–è¾‘é€»è¾‘ ---

        // å°†å½“å‰é€‰ä¸­çš„å›¾ç‰‡å¸ƒå±€ï¼ˆX,Y,Scaleï¼‰åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡
        function applyLayoutToAll() {
            if (activeIndex === -1 || !images[activeIndex]) return;

            const source = images[activeIndex];
            if(confirm(`ç¡®å®šè¦å°†å½“å‰å›¾ç‰‡ "${source.name}" çš„ä½ç½®å’Œç¼©æ”¾åº”ç”¨åˆ°å…¶ä»– ${images.length - 1} å¼ å›¾ç‰‡å—ï¼Ÿ`)) {
                images.forEach(img => {
                    img.x = source.x;
                    img.y = source.y;
                    img.scale = source.scale;
                });
                alert('å·²åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡ï¼');
                draw(); // åˆ·æ–°è§†å›¾
            }
        }

        function resetCurrentImage() {
            if (activeIndex === -1) return;
            const layout = calculateDefaultLayout(images[activeIndex].imgObj);
            images[activeIndex].x = layout.x;
            images[activeIndex].y = layout.y;
            images[activeIndex].scale = layout.scale;
            
            document.getElementById('scaleSlider').value = layout.scale;
            document.getElementById('scaleValue').innerText = Math.round(layout.scale * 100) + '%';
            
            draw();
        }

        function updateScaleFromSlider(val) {
            if (activeIndex === -1) return;
            
            const currentImg = images[activeIndex];
            const oldScale = currentImg.scale;
            const newScale = parseFloat(val);
            
            // ç®€å•çš„ä¸­å¿ƒç¼©æ”¾é€»è¾‘
            const imgW = currentImg.imgObj.width;
            const imgH = currentImg.imgObj.height;
            
            // è®¡ç®—å½“å‰ä¸­å¿ƒç‚¹
            const centerX = currentImg.x + (imgW * oldScale) / 2;
            const centerY = currentImg.y + (imgH * oldScale) / 2;
            
            // æ›´æ–° Scale
            currentImg.scale = newScale;
            
            // æ ¹æ®æ–° Scale é‡æ–°è®¡ç®— x,y ä»¥ä¿æŒä¸­å¿ƒä¸åŠ¨
            currentImg.x = centerX - (imgW * newScale) / 2;
            currentImg.y = centerY - (imgH * newScale) / 2;

            document.getElementById('scaleValue').innerText = Math.round(newScale * 100) + '%';
            draw();
        }

        // --- 3. æ¸²æŸ“ä¸ UI ---

        function draw() {
            // æ¸…ç©º
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // èƒŒæ™¯
            ctx.fillStyle = document.getElementById('bgColor').value;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç©ºçŠ¶æ€
            const emptyState = document.getElementById('emptyState');
            if (images.length === 0) {
                emptyState.style.display = 'block';
                return;
            } else {
                emptyState.style.display = 'none';
            }

            // ç»˜åˆ¶å½“å‰æ¿€æ´»çš„å›¾ç‰‡
            if (activeIndex !== -1 && images[activeIndex]) {
                const imgData = images[activeIndex];
                ctx.save();
                ctx.translate(imgData.x, imgData.y);
                ctx.scale(imgData.scale, imgData.scale);
                ctx.drawImage(imgData.imgObj, 0, 0);
                ctx.restore();
            }
        }

        function updateImageList() {
            const container = document.getElementById('imageListContainer');
            const list = document.getElementById('imgList');
            const count = document.getElementById('imgCount');
            const btnZip = document.getElementById('btnZip');

            if (images.length === 0) {
                container.classList.add('hidden');
                btnZip.disabled = true;
                return;
            }

            container.classList.remove('hidden');
            btnZip.disabled = false;
            count.textContent = images.length;
            
            list.innerHTML = '';
            images.forEach((imgData, idx) => {
                const div = document.createElement('div');
                div.className = `img-item p-2 rounded cursor-pointer border border-transparent flex justify-between items-center hover:bg-gray-100 ${idx === activeIndex ? 'active' : ''}`;
                div.onclick = () => setActiveImage(idx);
                
                div.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-8 h-8 bg-gray-200 rounded overflow-hidden flex-shrink-0 border border-gray-300">
                            <img src="${imgData.imgObj.src}" class="w-full h-full object-cover">
                        </div>
                        <span class="text-xs text-gray-700 truncate select-none">${imgData.name}</span>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 p-1" onclick="removeImage(event, ${idx})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function updateUI() {
            if (activeIndex !== -1 && images[activeIndex]) {
                const val = images[activeIndex].scale;
                document.getElementById('scaleSlider').value = val;
                document.getElementById('scaleValue').innerText = Math.round(val * 100) + '%';
            }
        }

        // --- 4. å¯¼å‡ºé€»è¾‘ ---

        function downloadCurrent() {
            if (images.length === 0) return alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
            
            const link = document.createElement('a');
            const currentName = images[activeIndex].name.replace(/\.[^/.]+$/, ""); // remove extension
            link.download = `${currentName}_edited.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        async function downloadAllZip() {
            if (images.length === 0) return;
            
            showLoading(true, `æ­£åœ¨æ‰“åŒ… ${images.length} å¼ å›¾ç‰‡...`);
            
            const zip = new JSZip();
            const folder = zip.folder("edited_images");
            
            // ä¸´æ—¶ Canvas ç”¨äºæ¸²æŸ“æ¯ä¸€å¸§ï¼Œé¿å…å±å¹•é—ªçƒï¼ˆè™½ç„¶ JS æ˜¯å•çº¿ç¨‹ï¼Œä½†è¿™æ›´å¹²å‡€ï¼‰
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tCtx = tempCanvas.getContext('2d');
            const bgColor = document.getElementById('bgColor').value;

            // å¾ªç¯å¤„ç†æ¯ä¸€å¼ å›¾
            for (let i = 0; i < images.length; i++) {
                const imgData = images[i];
                
                // æ¸²æŸ“åˆ°ä¸´æ—¶ Canvas
                tCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tCtx.fillStyle = bgColor;
                tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                tCtx.save();
                tCtx.translate(imgData.x, imgData.y);
                tCtx.scale(imgData.scale, imgData.scale);
                tCtx.drawImage(imgData.imgObj, 0, 0);
                tCtx.restore();

                // è½¬æ¢ä¸º Blob
                const blob = await new Promise(resolve => tempCanvas.toBlob(resolve, 'image/png'));
                const fileName = `${imgData.name.replace(/\.[^/.]+$/, "")}_edited_${i+1}.png`;
                
                folder.file(fileName, blob);
            }

            // ç”Ÿæˆ Zip
            const content = await zip.generateAsync({type: "blob"});
            
            // ä¸‹è½½
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "images_batch_export.zip";
            link.click();
            
            showLoading(false);
        }

        // --- 5. é€šç”¨å·¥å…· ---

        function showLoading(show, text="åŠ è½½ä¸­...") {
            const el = document.getElementById('loadingOverlay');
            const txt = document.getElementById('loadingText');
            if(show) {
                txt.textContent = text;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        function setResolution(w, h) {
            document.getElementById('canvasWidth').value = w;
            document.getElementById('canvasHeight').value = h;
            updateCanvasSize();
        }

        function updateCanvasSize() {
            const width = parseInt(document.getElementById('canvasWidth').value) || 1080;
            const height = parseInt(document.getElementById('canvasHeight').value) || 1080;
            canvas.width = width;
            canvas.height = height;
            resizeCanvasDisplay();
            draw();
            
            // ç”»å¸ƒå°ºå¯¸æ”¹å˜æ—¶ï¼Œæ˜¯å¦è¦é‡ç½®æ‰€æœ‰å›¾ç‰‡ä½ç½®ï¼Ÿ
            // æš‚æ—¶ä¸è‡ªåŠ¨é‡ç½®ï¼Œé¿å…ç”¨æˆ·è°ƒæ•´å¥½çš„ä½ç½®ä¸¢å¤±ã€‚
            // ä½†å¦‚æœç”¨æˆ·ä¸Šä¼ æ–°å›¾ï¼Œä¼šåŸºäºæ–°å°ºå¯¸è®¡ç®—ã€‚
        }

        function resizeCanvasDisplay() {
            const wrapperW = wrapper.clientWidth - 40;
            const wrapperH = wrapper.clientHeight - 40;
            const aspectRatio = canvas.width / canvas.height;
            let displayW, displayH;

            if (wrapperW / wrapperH > aspectRatio) {
                displayH = wrapperH;
                displayW = displayH * aspectRatio;
            } else {
                displayW = wrapperW;
                displayH = displayW / aspectRatio;
            }

            canvas.style.width = `${displayW}px`;
            canvas.style.height = `${displayH}px`;
        }

        window.addEventListener('resize', resizeCanvasDisplay);

        function setupEvents() {
            // é¼ æ ‡äº¤äº’
            canvas.addEventListener('mousedown', (e) => {
                if(activeIndex === -1) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                canvas.style.cursor = 'grabbing';
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging || activeIndex === -1) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                images[activeIndex].x += dx * scaleX;
                images[activeIndex].y += dy * scaleY;

                startX = e.clientX;
                startY = e.clientY;

                draw();
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.style.cursor = 'move';
            });

            canvas.addEventListener('wheel', (e) => {
                if(activeIndex === -1) return;
                e.preventDefault();
                
                const currentImg = images[activeIndex];
                const zoomIntensity = 0.05; // æ»šè½®ç¼©æ”¾é€Ÿåº¦æ”¾æ…¢ä¸€ç‚¹
                const delta = e.deltaY > 0 ? -1 : 1;
                const factor = 1 + (delta * zoomIntensity);

                const rect = canvas.getBoundingClientRect();
                const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
                const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);

                const newScale = Math.min(Math.max(0.1, currentImg.scale * factor), 10);

                currentImg.x = mouseX - (mouseX - currentImg.x) * (newScale / currentImg.scale);
                currentImg.y = mouseY - (mouseY - currentImg.y) * (newScale / currentImg.scale);
                currentImg.scale = newScale;

                // åŒæ­¥ UI
                document.getElementById('scaleSlider').value = newScale;
                document.getElementById('scaleValue').innerText = Math.round(newScale * 100) + '%';
                
                draw();
            }, { passive: false });
        }
    </script>
</body>
</html>